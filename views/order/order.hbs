<div class="content-wrapper">
    <div class="row">
        <div class="col-md-12 grid-margin">
            <div class="row">
                <div class="col-12 col-xl-12 mb-4 mb-xl-0">
                    <div class="row">
                        <h3 class="font-weight-bold mr-5"
                            style="margin-top: auto; margin-bottom: auto; margin-left: 1.5rem">Order</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-5">
        <div class="col-md-12 ">
            <div class="row">
                <div class="col-12 col-xl-4 mb-4 mb-xl-0">
                    {{!-- <div class="justify-content-end d-flex"> --}}
                        <form action="/packs/search" method="POST" class="justify-content-end d-flex mb-1" id="search-form">
                            <div class="input-group">
                                <input type="text" name="searchStr" class="form-control" id="search-input" placeholder="Search"
                                aria-label="search" aria-describedby="search">
                                <div type='submit' class="input-group-prepend hover-cursor" id="search-icon">
                                    <span class="input-group-text" id="userlist-search">
                                        <i class="icon-search"></i>
                                    </span>
                                </div>
                            </div>
                        </form>
                </div>

                <div class="col-12 col-xl-8">
                        <div class="justify-content-end d-flex">
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary">Sort</button>
                                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                                    id="dropdownMenuSplitButton1" data-toggle="dropdown" aria-haspopup="true"
                                    aria-expanded="false">
                                    <span class="sr-only">Toggle Dropdown</span>
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuSplitButton1">
                                    {{!-- <h6 class="dropdown-header">Header</h6> --}}
                                    <a class="dropdown-item" href="/orders/sort/?order-by=name-ascending">A-Z</a>
                                    <a class="dropdown-item"
                                        href="/orders/sort/?order-by=name-descending">Z-A</a>
                                    {{!-- <a class="dropdown-item" href="/packs/{{packDetail.id}}?order-by=price-ascending">Price
                                        ascending</a>
                                    <a class="dropdown-item" href="/packs/{{packDetail.id}}?order-by=price-descending">Price
                                        descending</a> --}}
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3 stretch-card grid-margin">
            <div class="card">
                <div class="card-body">
                    <p class="card-title mb-2">Package List</p>
                    <div class="table-responsive mb-4" style="height: 38%; overflow: auto;">
                        <table class="table table-borderless">
                            <thead>
                                <tr>
                                    <th class="pl-0 pb-2 border-bottom ">ID</th>
                                    <th class="border-bottom pb-2"><span class="ml-4">Name</span></th>
                                    {{!-- <th>Action</th> --}}
                                </tr>
                            </thead>
                            <tbody>
                                {{#each packs}}
                                <tr>
                                    <td class="pl-0"><span class="font-weight-bold">{{this.id}}</span></td>
                                    <td>
                                        <p class="ml-4 mb-0"><span class="font-weight-bold"></span><a
                                                href="/orders/{{this.id}}" class="font-weight-bold"
                                                style="text-decoration: none; color: #000;">
                                                {{this.name}}
                                            </a></span></p>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    <div class="row">
                        <i class="mdi mdi-cart ml-3"></i>
                        <p class="card-title ml-2 mb-2">Your Cart</p>
                    </div>
                    <div class="table-responsive mb-4" style="height: 36%; overflow: auto;">
                        <table class="table table-borderless" id="cartTable">
                            <thead>
                                <tr>
                                    <th class="pl-0 pb-2 border-bottom ">ID</th>
                                    <th class="border-bottom pb-2"><span class="ml-4">Name</span></th>
                                    <th class="border-bottom pb-2"></th>
                                </tr>
                            </thead>
                            <tbody id="listCart">
                            </tbody>
                        </table>
                    </div>
                    <div class="row mb-2">
                        <div style="width: 120px; margin-left: calc((100% - 120px)/2); margin-bottom: 20px">
                            <button id="checkOut" type="button" class="btn btn-success">Check out</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9 stretch-card grid-margin">
            <div class="card">
                <div class="card-body">
                    <p class="card-title mb-4">Package Detail</p>
                    <div class="row ml-0">
                        <div class="col-12 col-xl-9 mb-4 mb-xl-0">
                            <div class="row">
                                <div class="mb-4 stretch-card transparent">
                                    <div class="card card-light-blue" style="border-radius: 5px;">
                                        <div class="card-body" style="padding: 0.5rem;">
                                            <p class="mb-0" style="font-size: 1rem;" id="packNameCart" data-pack-id="{{packDetail.id}}" data-pack-name="{{packDetail.name}}">
                                                {{packDetail.name}}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4 ml-2 stretch-card transparent">
                                    <div class="card card-light-blue" style="border-radius: 5px;">
                                        <div class="card-body" style="padding: 0.5rem;">
                                            <p class="mb-0" style="font-size: 1rem;">Giới hạn mua:
                                                {{packDetail.quantity_limit}} lần/{{packDetail.time_limit_unit}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-xl-3" style="margin-top: -1rem;">
                            <div class="justify-content-end d-flex">
                                <button type="button" class="btn btn-success addToCart" onclick="addToCart()">Add to
                                    Cart</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive table-hover" style="height: 430px; overflow: auto;">
                        <table id="orderTable" class="table table-borderless">
                            <thead style="border-bottom: 2px solid black">
                                <tr>
                                    <th>Photo</th>
                                    <th>Name</th>
                                    <th>Price (VND)</th>
                                    <th>Unit</th>
                                    <th><span style="margin-left: 0.75rem;">Quantity</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each productsInPack}}
                                <tr data-product-id="{{this.id}}">
                                    <td class="py-1">
                                        <img src="/{{this.images.[0]}}" style="width:100px; height:100px" alt="image" />
                                        {{!-- <img src="/img/image 7.png" style="width:180px; height:180px"
                                            alt="image" /> --}}
                                    </td>
                                    <td id="nameProduct">{{this.name}}</td>
                                    <td id="price">{{this.price}}</td>
                                    <td>{{this.unit}}</td>
                                    <td><input type="number" min="0" max="{{this.quantity_limit}}" value="{{this.quantity_limit}}"
                                            style="text-align: center; max-width: 4rem; margin-left: 0.75rem"
                                            id="quantityProduct" /></td>
                                </tr>
                                {{/each}}
                                {{!-- <tr>
                                    <td class="py-1">
                                        <img src="/img/image 7.png" style="width:180px; height:180px" alt="image" />
                                    </td>
                                    <td>Kem đánh răng</td>
                                    <td>20 000</td>
                                    <td>Tube</td>
                                </tr> --}}

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{#section "js"}}
<script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.5/js/plugins/piexif.min.js"
    type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.5/js/plugins/sortable.min.js"
    type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.5/js/fileinput.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.5/js/locales/LANG.js"></script>

<script type="text/javascript">
    var cartList = []
    if (localStorage.getItem("cartList"))
        cartList = JSON.parse(localStorage.getItem("cartList"));

    let isNoData = {{isNoData}};
    if (isNoData == 1) {
        alert("No result matches");
    }

    $(document).ready(function () {
        window.pulse_continue_loop = true;
        window.pulse_image = $('.pulse_image');
        //cartlist = [];
        localStorage.setItem("cartList", JSON.stringify(cartList));
        showCart();

        $("#cartTable").on('click', '.deleteOrder', function () {
            // get the current row
            var currentRow = $(this).closest("tr").index();
            var list = JSON.parse(localStorage.getItem("cartList"));
            list.splice(currentRow, 1);
            localStorage.setItem("cartList", JSON.stringify(list));
            showCart();
        });

        $('#checkOut').on('click', function () {
            CheckOut();
        });
    })


    function showCart() {
        var list = JSON.parse(localStorage.getItem("cartList"));
        $("#listCart").empty();
        for (var i = 0; i < list.length; i++) {
            var cart = list[i];
            $("#listCart").append(`<tr>
                                    <td class="pl-0"><span class="font-weight-bold">${i + 1}</span></td>
                                    <td>
                                        <p style="margin: auto auto;"><span class="font-weight-bold"></span><a
                                                href=""
                                                style="text-decoration: none; color: #000;">
                                                ${cart.name}
                                            </a></span></p>
                                    </td>
                                    <td>
                                        <button class="badge badge-danger hover-cursor deleteOrder" style="border: none"><i class="icon-trash mx-2"></i></button>
                                    </td>    
                                </tr>`);
        }
    }

    function addToCart() {
        const packName = $("#packNameCart").data('pack-name');
        const packID = $("#packNameCart").data('pack-id');
        var list = JSON.parse(localStorage.getItem("cartList"));
        let exist = 0;
        if (list !== null) {
            for (var i = 0; i < list.length; i++) {
                if (list[i].name == packName) {
                    exist = 1;
                }
            }
        }
        
        console.log(exist);
        if (exist) {
            alert("You cannot buy the same product package in the same order");
        }
        else {
            var aData = [];
            $("#orderTable tbody tr").each(function () {
                var currentRow = $(this);
                var nameProduct = currentRow.find("td:eq(1)").text();
                var quantity = currentRow.find("#quantityProduct").val();
                var price = currentRow.find("#price").text();
                let productId = currentRow.data('product-id');

                var obj = {};
                obj.nameProduct = nameProduct;
                obj.quantity = quantity;
                obj.boughtPrice = quantity*price
                obj.productId = productId;
                aData.push(obj);
            });
            var objOrder = {};
            objOrder.name = packName;
            objOrder.id = packID;
            objOrder.productList = aData;
            list.push(objOrder);
            localStorage.setItem("cartList", JSON.stringify(list));
        }
        $("#listCart").empty();
        showCart();
    }

    async function onclickCheckOut() {
        var list = JSON.parse(localStorage.getItem("cartList"));

        $.ajax({
            url: `/orders/create`,
            type: 'POST',
            data: {
                list
            },
            success: async function (data, textStatus, jqXHR) {
                console.log('success: ', data);
                window.location.href = `/order-history`;
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('error: ', errorThrown);
            }
        });

        localStorage.removeItem("cartList");
    }

    $('#checkOut').click(onclickCheckOut);

    $("#search-icon").click(() => {
        console.log("helluuuu");
        let searchStr = $("#search-input").val();
        window.location.href=`/orders/search?searchStr=${searchStr}`;
    });

</script>

{{/section}}